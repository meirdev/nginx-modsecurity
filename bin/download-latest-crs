#!/usr/bin/env bash

set -euo pipefail

OWASP_CRS_BASE_URL="https://api.github.com/repos/coreruleset/coreruleset/releases/latest"

OWASP_CRS_DIR="/etc/owasp-crs"

LATEST_RELEASE_JSON=$(curl -sSL $OWASP_CRS_BASE_URL)

LATEST_RELEASE_VERSION=$(echo "$LATEST_RELEASE_JSON" | jq -r '.tag_name')

LATEST_RELEASE_URL=$(echo "$LATEST_RELEASE_JSON" | jq -r '.assets[] | select(.browser_download_url | endswith(".tar.gz")) | .browser_download_url')

FILENAME="${LATEST_RELEASE_URL##*/}"

TARGET_DIR=$OWASP_CRS_DIR/$LATEST_RELEASE_VERSION

mkdir -p $OWASP_CRS_DIR

curl -L -o $OWASP_CRS_DIR/$FILENAME $LATEST_RELEASE_URL

rm -rf $TARGET_DIR && mkdir -p $TARGET_DIR

tar -zxf $OWASP_CRS_DIR/$FILENAME --strip-components=1 -C $TARGET_DIR

rm $OWASP_CRS_DIR/$FILENAME

mv $TARGET_DIR/crs-setup.conf.example $TARGET_DIR/crs-setup.conf

rm -f $OWASP_CRS_DIR/latest && ln -sf $TARGET_DIR $OWASP_CRS_DIR/latest
